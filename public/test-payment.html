<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test VNPay Payment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .payment-methods {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .payment-method {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method:hover {
            border-color: #4CAF50;
            background: #f0f8f0;
        }

        .payment-method input[type="radio"] {
            margin-right: 15px;
            transform: scale(1.2);
        }

        .payment-method .icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .payment-method .details h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .payment-method .details p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .order-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }

        .order-summary h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .summary-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
            color: #4CAF50;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            border-bottom-color: #4CAF50;
            color: #4CAF50;
            font-weight: 600;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .payment-url {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            word-break: break-all;
        }

        .payment-url a {
            color: #4CAF50;
            text-decoration: none;
            font-weight: 600;
        }

        .payment-url a:hover {
            text-decoration: underline;
        }

        .test-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        /* Token Modal */
        .token-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .token-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .token-modal h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .token-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            font-family: monospace;
        }

        .token-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .token-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .token-actions .btn {
            width: auto;
            padding: 12px 25px;
        }

        .current-token {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .current-token .token-display {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .quick-test {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .quick-test h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .quick-test-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .quick-test-buttons .btn {
            padding: 10px 15px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .test-buttons {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Test VNPay Payment</h1>
            <p>Trang test thanh to√°n online v·ªõi VNPay</p>
            <p style="margin: 10px 0; opacity: 0.9; font-size: 14px;">
                üí° <strong>Tip:</strong> Token s·∫Ω ƒë∆∞·ª£c y√™u c·∫ßu nh·∫≠p qua alert khi g·ª≠i request
            </p>
            <button onclick="openTokenModal()" class="btn" style="margin-top: 15px; width: auto; padding: 10px 20px;">
                üîë C√†i ƒë·∫∑t Token
            </button>
        </div>

        <div class="content">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('order')">üì¶ T·∫°o ƒë∆°n h√†ng</div>
                <div class="tab" onclick="switchTab('payment')">üí≥ Test Payment</div>
                <div class="tab" onclick="switchTab('status')">üìä Tr·∫°ng th√°i</div>
            </div>

            <!-- Tab 1: T·∫°o ƒë∆°n h√†ng -->
            <div id="order-tab" class="tab-content active">
                <div class="current-token">
                    <strong>üîë Token hi·ªán t·∫°i:</strong>
                    <div class="token-display" id="currentTokenDisplay">Ch∆∞a c√≥ token</div>
                    <button onclick="openTokenModal()" class="btn" style="width: auto; padding: 8px 16px; font-size: 14px;">
                        üîÑ Thay ƒë·ªïi Token
                    </button>
                </div>

                <div class="quick-test">
                    <h4>üöÄ Quick Test - Test nhanh v·ªõi d·ªØ li·ªáu m·∫´u:</h4>
                    <div class="quick-test-buttons">
                        <button onclick="quickTest('cod')" class="btn">üí∞ Test COD Order</button>
                        <button onclick="quickTest('online_payment')" class="btn">üí≥ Test VNPay Order</button>
                        <button onclick="quickTest('test_payment')" class="btn">üîó Test Payment URL</button>
                        <button onclick="quickTest('check_status')" class="btn">üìä Test Check Status</button>
                                                 <button onclick="testApiEndpoint()" class="btn" style="background: #17a2b8;">üîç Test API Endpoint</button>
                         <button onclick="testVnpayPayment()" class="btn" style="background: #ffc107; color: #000;">üí≥ Test VNPay Payment</button>
                    </div>
                </div>

                <h2>üì¶ T·∫°o ƒë∆°n h√†ng m·ªõi</h2>
                                 <form id="orderForm">
                     <div class="form-row">
                         <div class="form-group">
                             <label for="name">T√™n ng∆∞·ªùi nh·∫≠n:</label>
                             <input type="text" id="name" name="name" value="Nguy·ªÖn VƒÉn Test" required>
                         </div>
                         <div class="form-group">
                             <label for="email">Email:</label>
                             <input type="email" id="email" name="email" value="test@example.com" required>
                         </div>
                     </div>

                     <div class="form-row">
                         <div class="form-group">
                             <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                             <input type="tel" id="phone" name="phone" value="0123456789" required>
                         </div>
                         <div class="form-group">
                             <label for="total">T·ªïng ti·ªÅn (VND):</label>
                             <input type="number" id="total" name="total" value="100000" min="1000" required>
                         </div>
                     </div>

                     <div class="form-group">
                         <label for="address">ƒê·ªãa ch·ªâ giao h√†ng:</label>
                         <textarea id="address" name="address" rows="3" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng..." required>123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM</textarea>
                     </div>

                     <div class="form-group">
                         <label for="notes">Ghi ch√∫:</label>
                         <textarea id="notes" name="notes" rows="2" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng...">Test order for VNPay payment</textarea>
                     </div>

                    <div class="payment-methods">
                        <h3>üí≥ Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n:</h3>
                        
                        <div class="payment-method">
                            <input type="radio" id="cod" name="payment_method" value="cod" checked>
                            <span class="icon">üí∞</span>
                            <div class="details">
                                <h4>Thanh to√°n khi nh·∫≠n h√†ng (COD)</h4>
                                <p>Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</p>
                            </div>
                        </div>
                        
                        <div class="payment-method">
                            <input type="radio" id="online_payment" name="payment_method" value="online_payment">
                            <span class="icon">üí≥</span>
                            <div class="details">
                                <h4>Thanh to√°n online (VNPay)</h4>
                                <p>Thanh to√°n qua th·∫ª ATM, th·∫ª qu·ªëc t·∫ø, v√≠ ƒëi·ªán t·ª≠</p>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn">üöÄ T·∫°o ƒë∆°n h√†ng</button>
                </form>

                <div id="orderResult" class="result"></div>
            </div>

            <!-- Tab 2: Test Payment -->
            <div id="payment-tab" class="tab-content">
                <h2>üí≥ Test VNPay Payment</h2>
                
                <div class="form-group">
                    <label for="test_order_id">Order ID:</label>
                    <input type="number" id="test_order_id" name="test_order_id" placeholder="Nh·∫≠p Order ID ƒë·ªÉ test payment..." required>
                </div>

                <div class="form-group">
                    <label for="test_amount">S·ªë ti·ªÅn (VND):</label>
                    <input type="number" id="test_amount" name="test_amount" value="100000" min="1000" required>
                </div>

                <div class="test-buttons">
                    <button onclick="testCreatePayment()" class="btn">üîó T·∫°o Payment URL</button>
                    <button onclick="testPaymentReturn()" class="btn btn-secondary">üîÑ Test Return URL</button>
                </div>

                <div id="paymentResult" class="result"></div>
                <div id="paymentLoading" class="loading">
                    <div class="spinner"></div>
                    <p>ƒêang x·ª≠ l√Ω...</p>
                </div>
            </div>

            <!-- Tab 3: Tr·∫°ng th√°i -->
            <div id="status-tab" class="tab-content">
                <h2>üìä Ki·ªÉm tra tr·∫°ng th√°i</h2>
                
                <div class="form-group">
                    <label for="check_order_id">Order ID:</label>
                    <input type="number" id="check_order_id" name="check_order_id" placeholder="Nh·∫≠p Order ID ƒë·ªÉ ki·ªÉm tra..." required>
                </div>

                <button onclick="checkOrderStatus()" class="btn">üîç Ki·ªÉm tra tr·∫°ng th√°i</button>

                <div id="statusResult" class="result"></div>
                <div id="statusLoading" class="loading">
                    <div class="spinner"></div>
                    <p>ƒêang ki·ªÉm tra...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Token Modal -->
    <div id="tokenModal" class="token-modal">
        <div class="token-modal-content">
            <h3>üîë C√†i ƒë·∫∑t Token Authentication</h3>
            <p style="text-align: center; margin-bottom: 20px; color: #666;">
                Nh·∫≠p token ƒë·ªÉ test API. C√≥ th·ªÉ s·ª≠ d·ª•ng token th·∫≠t ho·∫∑c token test.
            </p>
            
            <input type="text" id="tokenInput" class="token-input" placeholder="Nh·∫≠p Bearer token (v√≠ d·ª•: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...)">
            
            <div class="token-actions">
                <button onclick="saveToken()" class="btn">üíæ L∆∞u Token</button>
                <button onclick="closeTokenModal()" class="btn btn-secondary">‚ùå H·ªßy</button>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4>üí° Token m·∫´u ƒë·ªÉ test:</h4>
                <ul style="text-align: left; margin: 10px 0;">
                    <li><strong>Test Token:</strong> <code>Bearer test-token</code></li>
                    <li><strong>Real Token:</strong> <code>Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...</code></li>
                    <li><strong>No Token:</strong> ƒê·ªÉ tr·ªëng ƒë·ªÉ test kh√¥ng c√≥ authentication</li>
                </ul>
                
                <h4>üîç Debug Tips:</h4>
                <ul style="text-align: left; margin: 10px 0;">
                    <li><strong>M·ªü Console (F12):</strong> Xem log debug chi ti·∫øt</li>
                    <li><strong>Ki·ªÉm tra Network tab:</strong> Xem request/response headers</li>
                    <li><strong>Token format:</strong> Ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "Bearer " (c√≥ d·∫•u c√°ch)</li>
                </ul>
                
                <h4>‚å®Ô∏è Keyboard Shortcuts:</h4>
                <ul style="text-align: left; margin: 10px 0;">
                    <li><strong>Ctrl+Enter:</strong> Submit form t·∫°o ƒë∆°n h√†ng</li>
                    <li><strong>Ctrl+T:</strong> M·ªü modal c√†i ƒë·∫∑t token</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let currentOrder = null;
        let currentToken = 'Bearer test-token'; // Default token

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Handle order form submission
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Hi·ªÉn th·ªã alert ƒë·ªÉ nh·∫≠p token
            const token = prompt('üîë Nh·∫≠p Bearer Token ƒë·ªÉ g·ª≠i request:', currentToken || 'Bearer ');
            if (token === null) return; // User cancel
            
            // Debug: Hi·ªÉn th·ªã token ƒëang s·ª≠ d·ª•ng
            console.log('üîë Token ƒëang s·ª≠ d·ª•ng:', token);
            console.log('üì§ Request headers:', {
                'Content-Type': 'application/json',
                'Authorization': token,
                'Accept': 'application/json'
            });
            
                         const formData = new FormData(this);
             const orderData = {
                 name: formData.get('name'),
                 email: formData.get('email'),
                 phone: formData.get('phone'),
                 address: formData.get('address'),
                 notes: formData.get('notes'),
                 payment_method: formData.get('payment_method'),
                 subtotal: parseInt(formData.get('total')),
                 total: parseInt(formData.get('total')),
                 items: [
                     {
                         product_id: 2,
                         variant_id: 1,
                         quantity: 1,
                         price: parseInt(formData.get('total'))
                     }
                 ]
             };

            console.log('üì¶ Order data:', orderData);

            try {
                const response = await fetch('http://localhost:8000/api/v1/user/orders/place-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();
                
                console.log('üì• Response status:', response.status);
                console.log('üì• Response headers:', Object.fromEntries(response.headers.entries()));
                console.log('üì• Response body:', result);
                
                if (response.ok) {
                    currentOrder = result;
                                         showResult('orderResult', 'success', `
                         <h3>‚úÖ ƒê∆°n h√†ng t·∫°o th√†nh c√¥ng!</h3>
                         <div class="order-summary">
                             <h3>Th√¥ng tin ƒë∆°n h√†ng:</h3>
                             <div class="summary-item">
                                 <span>Order ID:</span>
                                 <span>#${result.order_id}</span>
                             </div>
                             <div class="summary-item">
                                 <span>Order Number:</span>
                                 <span>${result.order_number}</span>
                             </div>
                             <div class="summary-item">
                                 <span>Ph∆∞∆°ng th·ª©c thanh to√°n:</span>
                                 <span>${result.order.payment_method === 'online_payment' ? 'VNPay' : 'COD'}</span>
                             </div>
                             <div class="summary-item">
                                 <span>T·ªïng ti·ªÅn:</span>
                                 <span>${result.order.total.toLocaleString('vi-VN')} VND</span>
                             </div>
                         </div>
                         
                         <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                             <strong>üîç Debug Response Data:</strong><br>
                             <code style="font-size: 11px; word-break: break-all;">${JSON.stringify(result, null, 2)}</code>
                         </div>
                         
                         ${result.payment ? `
                             <div class="payment-url">
                                 <strong>üîó Payment URL:</strong><br>
                                 <a href="${result.payment.payment_url || result.payment.data?.payment_url || '#'}" target="_blank">${result.payment.payment_url || result.payment.data?.payment_url || 'Payment URL kh√¥ng kh·∫£ d·ª•ng'}</a>
                             </div>
                             <button onclick="window.open('${result.payment.payment_url || result.payment.data?.payment_url || '#'}', '_blank')" class="btn" ${!result.payment.payment_url && !result.payment.data?.payment_url ? 'disabled' : ''}>
                                 üöÄ M·ªü VNPay Payment
                             </button>
                             <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
                                 <strong>üîç Debug Payment Data:</strong><br>
                                 <code>${JSON.stringify(result.payment, null, 2)}</code>
                             </div>
                         ` : '<div style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 5px; color: #721c24;"><strong>‚ö†Ô∏è Kh√¥ng c√≥ payment data</strong><br>ƒê∆°n h√†ng COD kh√¥ng c·∫ßn payment URL</div>'}
                     `);
                    
                    // Auto-fill test fields
                    document.getElementById('test_order_id').value = result.order_id;
                    document.getElementById('test_amount').value = result.order.total;
                    document.getElementById('check_order_id').value = result.order_id;
                } else {
                    showResult('orderResult', 'error', `
                        <h3>‚ùå L·ªói t·∫°o ƒë∆°n h√†ng (HTTP ${response.status})</h3>
                        <p><strong>Status:</strong> ${response.status} - ${response.statusText}</p>
                        <p><strong>Message:</strong> ${result.message || 'Unknown error'}</p>
                        ${result.errors ? `<p><strong>Errors:</strong> ${JSON.stringify(result.errors)}</p>` : ''}
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>üîç Debug Info:</strong><br>
                            <strong>Token:</strong> ${token}<br>
                            <strong>URL:</strong> http://localhost:8000/api/v1/user/orders/place-order<br>
                            <strong>Method:</strong> POST
                        </div>
                    `);
                }
            } catch (error) {
                                 showResult('orderResult', 'error', `
                     <h3>‚ùå L·ªói k·∫øt n·ªëi</h3>
                     <p><strong>Error:</strong> ${error.message}</p>
                     <p>Vui l√≤ng ki·ªÉm tra:</p>
                     <ul style="text-align: left; margin: 10px 0;">
                         <li>Laravel server c√≥ ƒëang ch·∫°y tr√™n port 8000 kh√¥ng?</li>
                         <li>C√≥ b·ªã l·ªói CORS kh√¥ng?</li>
                         <li>API routes c√≥ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ƒë√∫ng kh√¥ng?</li>
                     </ul>
                 `);
            }
        });

        // Test create payment
        async function testCreatePayment() {
            const orderId = document.getElementById('test_order_id').value;
            const amount = document.getElementById('test_amount').value;
            
            if (!orderId || !amount) {
                showResult('paymentResult', 'error', '<h3>‚ùå Vui l√≤ng nh·∫≠p Order ID v√† s·ªë ti·ªÅn</h3>');
                return;
            }

            // Hi·ªÉn th·ªã alert ƒë·ªÉ nh·∫≠p token
            const token = prompt('üîë Nh·∫≠p Bearer Token ƒë·ªÉ g·ª≠i request:', currentToken || 'Bearer ');
            if (token === null) return; // User cancel

            showLoading('paymentLoading', true);
            showResult('paymentResult', '', '');

            try {
                const response = await fetch('http://localhost:8000/api/v1/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: parseInt(orderId),
                        amount: parseInt(amount)
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('paymentResult', 'success', `
                        <h3>‚úÖ T·∫°o Payment URL th√†nh c√¥ng!</h3>
                        <div class="payment-url">
                            <strong>üîó Payment URL:</strong><br>
                            <a href="${result.data.payment_url}" target="_blank">${result.data.payment_url}</a>
                        </div>
                        <div class="test-buttons">
                            <button onclick="window.open('${result.data.payment_url}', '_blank')" class="btn">
                                üöÄ M·ªü VNPay Payment
                            </button>
                            <button onclick="testPaymentReturn()" class="btn btn-secondary">
                                üîÑ Test Return URL
                            </button>
                        </div>
                    `);
                } else {
                    showResult('paymentResult', 'error', `
                        <h3>‚ùå L·ªói t·∫°o Payment URL</h3>
                        <p><strong>Message:</strong> ${result.message || 'Unknown error'}</p>
                    `);
                }
            } catch (error) {
                showResult('paymentResult', 'error', `
                    <h3>‚ùå L·ªói k·∫øt n·ªëi</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                `);
            } finally {
                showLoading('paymentLoading', false);
            }
        }

        // Test payment return
        async function testPaymentReturn() {
            const orderId = document.getElementById('test_order_id').value;
            
            if (!orderId) {
                showResult('paymentResult', 'error', '<h3>‚ùå Vui l√≤ng nh·∫≠p Order ID</h3>');
                return;
            }

            // Simulate VNPay return with success
            const testParams = new URLSearchParams({
                vnp_ResponseCode: '00',
                vnp_TxnRef: orderId,
                vnp_Amount: '10000000', // 100,000 VND * 100
                vnp_TransactionNo: 'TEST_' + Date.now(),
                vnp_OrderInfo: 'Test payment',
                vnp_TransactionStatus: '00'
            });

            const returnUrl = `http://localhost:8000/payment/return?${testParams.toString()}`;
            
            showResult('paymentResult', 'info', `
                <h3>üîÑ Test Return URL</h3>
                <p><strong>Test URL:</strong> <a href="${returnUrl}" target="_blank">${returnUrl}</a></p>
                <button onclick="window.open('${returnUrl}', '_blank')" class="btn">
                    üîÑ Test Return URL
                </button>
            `);
        }

        // Check order status
        async function checkOrderStatus() {
            const orderId = document.getElementById('check_order_id').value;
            
            if (!orderId) {
                showResult('statusResult', 'error', '<h3>‚ùå Vui l√≤ng nh·∫≠p Order ID</h3>');
                return;
            }

            // Hi·ªÉn th·ªã alert ƒë·ªÉ nh·∫≠p token
            const token = prompt('üîë Nh·∫≠p Bearer Token ƒë·ªÉ g·ª≠i request:', currentToken || 'Bearer ');
            if (token === null) return; // User cancel

            showLoading('statusLoading', true);
            showResult('statusResult', '', '');

            try {
                const response = await fetch(`http://localhost:8000/api/v1/user/orders/${orderId}`, {
                    headers: {
                        'Authorization': token
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    const order = result.data;
                    showResult('statusResult', 'success', `
                        <h3>‚úÖ Th√¥ng tin ƒë∆°n h√†ng</h3>
                        <div class="order-summary">
                            <div class="summary-item">
                                <span>Order ID:</span>
                                <span>#${order.id}</span>
                            </div>
                            <div class="summary-item">
                                <span>Status:</span>
                                <span>${order.status}</span>
                            </div>
                            <div class="summary-item">
                                <span>Payment Method:</span>
                                <span>${order.payment_method}</span>
                            </div>
                            <div class="summary-item">
                                <span>Payment Status:</span>
                                <span>${order.payment_status || 'N/A'}</span>
                            </div>
                            <div class="summary-item">
                                <span>Total:</span>
                                <span>${order.total.toLocaleString('vi-VN')} VND</span>
                            </div>
                        </div>
                    `);
                } else {
                    showResult('statusResult', 'error', `
                        <h3>‚ùå L·ªói ki·ªÉm tra ƒë∆°n h√†ng</h3>
                        <p><strong>Message:</strong> ${result.message || 'Unknown error'}</p>
                    `);
                }
            } catch (error) {
                showResult('statusResult', 'error', `
                    <h3>‚ùå L·ªói k·∫øt n·ªëi</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                `);
            } finally {
                showLoading('statusLoading', false);
            }
        }

        // Helper functions
        function showResult(elementId, type, content) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = content;
            element.style.display = content ? 'block' : 'none';
        }

        function showLoading(elementId, show) {
            const element = document.getElementById(elementId);
            element.style.display = show ? 'block' : 'none';
        }

        // Token Modal Functions
        function openTokenModal() {
            document.getElementById('tokenModal').style.display = 'block';
            document.getElementById('tokenInput').value = currentToken;
            document.getElementById('tokenInput').focus();
        }

        function closeTokenModal() {
            document.getElementById('tokenModal').style.display = 'none';
        }

        function saveToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (token) {
                currentToken = token;
                updateTokenDisplay();
                closeTokenModal();
                showResult('orderResult', 'success', `
                    <h3>‚úÖ Token ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!</h3>
                    <p>Token m·ªõi: <code>${token}</code></p>
                `);
            } else {
                currentToken = '';
                updateTokenDisplay();
                closeTokenModal();
                showResult('orderResult', 'info', `
                    <h3>‚ÑπÔ∏è Token ƒë√£ ƒë∆∞·ª£c x√≥a</h3>
                    <p>API calls s·∫Ω kh√¥ng c√≥ Authorization header</p>
                `);
            }
        }

        function updateTokenDisplay() {
            const display = document.getElementById('currentTokenDisplay');
            if (currentToken) {
                display.textContent = currentToken;
                display.style.color = '#28a745';
            } else {
                display.textContent = 'Kh√¥ng c√≥ token';
                display.style.color = '#dc3545';
            }
        }

        // Quick Test Functions
        function quickTest(type) {
            switch(type) {
                                 case 'cod':
                     // Test COD order
                     document.getElementById('cod').checked = true;
                     document.getElementById('name').value = 'Quick Test User';
                     document.getElementById('email').value = 'quicktest@example.com';
                     document.getElementById('total').value = '50000';
                     document.getElementById('address').value = 'Quick Test - COD Order';
                     document.getElementById('phone').value = '0987654321';
                     document.getElementById('notes').value = 'Quick test COD order';
                     showResult('orderResult', 'info', '<h3>üöÄ Quick Test COD Order</h3><p>Form ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn s·∫µn. Click "üöÄ T·∫°o ƒë∆°n h√†ng" ƒë·ªÉ test!</p>');
                     break;
                     
                 case 'online_payment':
                     // Test VNPay order
                     document.getElementById('online_payment').checked = true;
                     document.getElementById('name').value = 'Quick Test User';
                     document.getElementById('email').value = 'quicktest@example.com';
                     document.getElementById('total').value = '100000';
                     document.getElementById('address').value = 'Quick Test - VNPay Order';
                     document.getElementById('phone').value = '0987654321';
                     document.getElementById('notes').value = 'Quick test VNPay order';
                     showResult('orderResult', 'info', '<h3>üöÄ Quick Test VNPay Order</h3><p>Form ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn s·∫µn. Click "üöÄ T·∫°o ƒë∆°n h√†ng" ƒë·ªÉ test!</p>');
                     break;
                    
                case 'test_payment':
                    // Test payment URL
                    document.getElementById('test_order_id').value = '1';
                    document.getElementById('test_amount').value = '100000';
                    switchTab('payment');
                    showResult('paymentResult', 'info', '<h3>üöÄ Quick Test Payment</h3><p>Form ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn s·∫µn. Click "üîó T·∫°o Payment URL" ƒë·ªÉ test!</p>');
                    break;
                    
                case 'check_status':
                    // Test check status
                    document.getElementById('check_order_id').value = '1';
                    switchTab('status');
                    showResult('statusResult', 'info', '<h3>üöÄ Quick Test Check Status</h3><p>Form ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn s·∫µn. Click "üîç Ki·ªÉm tra tr·∫°ng th√°i" ƒë·ªÉ test!</p>');
                    break;
            }
        }

        // Test API Endpoint Function
        async function testApiEndpoint() {
            const token = prompt('üîë Nh·∫≠p Bearer Token ƒë·ªÉ test API endpoint:', currentToken || 'Bearer ');
            if (token === null) return;

            showResult('orderResult', 'info', '<h3>üîç ƒêang test API endpoint...</h3><p>Ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt</p>');

            try {
                console.log('üîç Testing API endpoint...');
                console.log('üîë Token:', token);
                console.log('üåê URL: http://localhost:8000/api/v1/user/orders/place-order');

                                 // Test v·ªõi request ƒë∆°n gi·∫£n
                 const testData = {
                     name: 'Test User',
                     email: 'test@example.com',
                     phone: '0123456789',
                     address: 'Test API Endpoint',
                     notes: 'Test API endpoint',
                     payment_method: 'cod',
                     subtotal: 100000,
                     total: 100000,
                     items: [
                         {
                             product_id: 1,
                             variant_id: 1,
                             quantity: 1,
                             price: 100000
                         }
                     ]
                 };

                console.log('üì§ Test data:', testData);

                const response = await fetch('http://localhost:8000/api/v1/user/orders/place-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response status text:', response.statusText);
                console.log('üì• Response headers:', Object.fromEntries(response.headers.entries()));

                const result = await response.json();
                console.log('üì• Response body:', result);

                if (response.ok) {
                    showResult('orderResult', 'success', `
                        <h3>‚úÖ API Endpoint ho·∫°t ƒë·ªông!</h3>
                        <p><strong>Status:</strong> ${response.status} - ${response.statusText}</p>
                        <p><strong>Order ID:</strong> ${result.order_id}</p>
                        <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                            <strong>üîç Debug Info:</strong><br>
                            <strong>Token:</strong> ${token}<br>
                            <strong>Response Headers:</strong> ${JSON.stringify(Object.fromEntries(response.headers.entries()))}
                        </div>
                    `);
                } else {
                    showResult('orderResult', 'error', `
                        <h3>‚ùå API Endpoint l·ªói (HTTP ${response.status})</h3>
                        <p><strong>Status:</strong> ${response.status} - ${response.statusText}</p>
                        <p><strong>Message:</strong> ${result.message || 'Unknown error'}</p>
                        <div style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 5px;">
                            <strong>üîç Debug Info:</strong><br>
                            <strong>Token:</strong> ${token}<br>
                            <strong>Response Headers:</strong> ${JSON.stringify(Object.fromEntries(response.headers.entries()))}<br>
                            <strong>Response Body:</strong> ${JSON.stringify(result)}
                        </div>
                    `);
                }
            } catch (error) {
                console.error('‚ùå Error testing API endpoint:', error);
                showResult('orderResult', 'error', `
                    <h3>‚ùå L·ªói k·∫øt n·ªëi API endpoint</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <div style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 5px;">
                        <strong>üîç Debug Info:</strong><br>
                        <strong>Error Type:</strong> ${error.name}<br>
                        <strong>Error Message:</strong> ${error.message}<br>
                        <strong>Stack Trace:</strong> ${error.stack}
                    </div>
                `);
            }
                 }

         // Test VNPay Payment Function
         async function testVnpayPayment() {
             const token = prompt('üîë Nh·∫≠p Bearer Token ƒë·ªÉ test VNPay payment:', currentToken || 'Bearer ');
             if (token === null) return;

             showResult('orderResult', 'info', '<h3>üí≥ ƒêang test VNPay payment...</h3><p>Ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt</p>');

             try {
                 console.log('üí≥ Testing VNPay payment...');
                 console.log('üîë Token:', token);

                 // Test v·ªõi VNPay order
                 const testData = {
                     name: 'VNPay Test User',
                     email: 'vnpay@example.com',
                     phone: '0123456789',
                     address: 'Test VNPay Payment',
                     notes: 'Test VNPay payment order',
                     payment_method: 'online_payment',
                     subtotal: 100000,
                     total: 100000,
                     items: [
                         {
                             product_id: 2,
                             variant_id: 1,
                             quantity: 1,
                             price: 100000
                         }
                     ]
                 };

                 console.log('üì§ VNPay test data:', testData);

                 const response = await fetch('http://localhost:8000/api/v1/user/orders/place-order', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'Authorization': token,
                         'Accept': 'application/json'
                     },
                     body: JSON.stringify(testData)
                 });

                 console.log('üì• VNPay Response status:', response.status);
                 console.log('üì• VNPay Response status text:', response.statusText);
                 console.log('üì• VNPay Response headers:', Object.fromEntries(response.headers.entries()));

                 const result = await response.json();
                 console.log('üì• VNPay Response body:', result);

                 if (response.ok) {
                     showResult('orderResult', 'success', `
                         <h3>‚úÖ VNPay Payment Test th√†nh c√¥ng!</h3>
                         <p><strong>Status:</strong> ${response.status} - ${response.statusText}</p>
                         <p><strong>Order ID:</strong> ${result.order_id}</p>
                         <p><strong>Payment Method:</strong> ${result.order?.payment_method || 'N/A'}</p>
                         
                         <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                             <strong>üîç Full Response Data:</strong><br>
                             <code style="font-size: 11px; word-break: break-all;">${JSON.stringify(result, null, 2)}</code>
                         </div>
                         
                         ${result.payment ? `
                             <div class="payment-url" style="margin-top: 15px;">
                                 <strong>üîó Payment Data Found:</strong><br>
                                 <code style="font-size: 11px; word-break: break-all;">${JSON.stringify(result.payment, null, 2)}</code>
                             </div>
                             
                             <div class="payment-url" style="margin-top: 15px;">
                                 <strong>üîó Payment URL:</strong><br>
                                 <a href="${result.payment.payment_url || result.payment.data?.payment_url || '#'}" target="_blank">${result.payment.payment_url || result.payment.data?.payment_url || 'Payment URL kh√¥ng kh·∫£ d·ª•ng'}</a>
                             </div>
                             
                             <button onclick="window.open('${result.payment.payment_url || result.payment.data?.payment_url || '#'}', '_blank')" class="btn" style="margin-top: 10px;" ${!result.payment.payment_url && !result.payment.data?.payment_url ? 'disabled' : ''}>
                                 üöÄ M·ªü VNPay Payment
                             </button>
                         ` : '<div style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 5px; color: #721c24;"><strong>‚ö†Ô∏è Kh√¥ng c√≥ payment data</strong><br>Ki·ªÉm tra console ƒë·ªÉ xem response chi ti·∫øt</div>'}
                     `);
                 } else {
                     showResult('orderResult', 'error', `
                         <h3>‚ùå VNPay Payment Test l·ªói (HTTP ${response.status})</h3>
                         <p><strong>Status:</strong> ${response.status} - ${response.statusText}</p>
                         <p><strong>Message:</strong> ${result.message || 'Unknown error'}</p>
                         <div style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 5px;">
                             <strong>üîç Debug Info:</strong><br>
                             <strong>Token:</strong> ${token}<br>
                             <strong>Response Headers:</strong> ${JSON.stringify(Object.fromEntries(response.headers.entries()))}<br>
                             <strong>Response Body:</strong> ${JSON.stringify(result)}
                         </div>
                     `);
                 }
             } catch (error) {
                 console.error('‚ùå Error testing VNPay payment:', error);
                 showResult('orderResult', 'error', `
                     <h3>‚ùå L·ªói k·∫øt n·ªëi VNPay payment</h3>
                     <p><strong>Error:</strong> ${error.message}</p>
                     <div style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 5px;">
                         <strong>üîç Debug Info:</strong><br>
                         <strong>Error Type:</strong> ${error.name}<br>
                         <strong>Error Message:</strong> ${error.message}<br>
                         <strong>Stack Trace:</strong> ${error.stack}
                     </div>
                 `);
             }
         }

         // Auto-fill test data
         document.addEventListener('DOMContentLoaded', function() {
             // Set default values
             document.getElementById('name').value = 'Nguy·ªÖn VƒÉn Test';
             document.getElementById('email').value = 'test@example.com';
             document.getElementById('total').value = '100000';
             document.getElementById('address').value = '123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM';
             document.getElementById('phone').value = '0123456789';
             document.getElementById('notes').value = 'Test order for VNPay payment';
            
            // Initialize token display
            updateTokenDisplay();
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('tokenModal');
                if (event.target === modal) {
                    closeTokenModal();
                }
            }

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter to submit order form
                if (e.ctrlKey && e.key === 'Enter') {
                    document.getElementById('orderForm').dispatchEvent(new Event('submit'));
                }
                // Ctrl+T to open token modal
                if (e.ctrlKey && e.key === 't') {
                    e.preventDefault();
                    openTokenModal();
                }
            });
        });
    </script>
</body>
</html>
