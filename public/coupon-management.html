<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω M√£ gi·∫£m gi√°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .controls-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .coupons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .coupon-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid #667eea;
        }

        .coupon-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .coupon-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .coupon-code {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        .coupon-status {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .coupon-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .coupon-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            font-size: 14px;
        }

        .detail-label {
            color: #888;
            font-weight: 500;
        }

        .detail-value {
            color: #333;
            font-weight: 600;
        }

        .coupon-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .pagination button:hover {
            background: #f8f9fa;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .coupons-grid {
                grid-template-columns: 1fr;
            }
            
            .coupon-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé´ Qu·∫£n l√Ω M√£ gi·∫£m gi√°</h1>
            <p>Qu·∫£n l√Ω v√† t·∫°o m√£ gi·∫£m gi√° cho kh√°ch h√†ng m·ªôt c√°ch d·ªÖ d√†ng</p>
        </div>

        <div class="controls">
            <div class="controls-row">
                <div class="form-group">
                    <label for="search">T√¨m ki·∫øm:</label>
                    <input type="text" id="search" placeholder="Nh·∫≠p m√£ ho·∫∑c m√¥ t·∫£...">
                </div>
                <div class="form-group">
                    <label for="status-filter">Tr·∫°ng th√°i:</label>
                    <select id="status-filter">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="1">ƒêang ho·∫°t ƒë·ªông</option>
                        <option value="0">Kh√¥ng ho·∫°t ƒë·ªông</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="type-filter">Lo·∫°i:</label>
                    <select id="type-filter">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="percent">Ph·∫ßn trƒÉm</option>
                        <option value="fixed">C·ªë ƒë·ªãnh</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="scope-filter">Ph·∫°m vi:</label>
                    <select id="scope-filter">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="order">ƒê∆°n h√†ng</option>
                        <option value="product">S·∫£n ph·∫©m</option>
                        <option value="category">Danh m·ª•c</option>
                        <option value="shipping">V·∫≠n chuy·ªÉn</option>
                    </select>
                </div>
            </div>
            <div class="controls-row">
                <button class="btn btn-primary" onclick="loadCoupons()">üîç T√¨m ki·∫øm</button>
                <button class="btn btn-success" onclick="openCreateModal()">‚ûï T·∫°o m√£ m·ªõi</button>
                <button class="btn btn-secondary" onclick="exportCoupons()">üìä Xu·∫•t d·ªØ li·ªáu</button>
            </div>
        </div>

        <div id="coupons-container">
            <div class="loading">ƒêang t·∫£i danh s√°ch m√£ gi·∫£m gi√°...</div>
        </div>

        <div id="pagination" class="pagination"></div>
    </div>

    <!-- Modal t·∫°o/s·ª≠a m√£ gi·∫£m gi√° -->
    <div id="couponModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="modal-title">T·∫°o m√£ gi·∫£m gi√° m·ªõi</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="alert-container"></div>
            <form id="couponForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="code">M√£ gi·∫£m gi√° *</label>
                        <input type="text" id="code" name="code" required maxlength="50" placeholder="V√≠ d·ª•: SALE20">
                    </div>
                    <div class="form-group">
                        <label for="type">Lo·∫°i gi·∫£m gi√° *</label>
                        <select id="type" name="type" required>
                            <option value="percent">Ph·∫ßn trƒÉm (%)</option>
                            <option value="fixed">S·ªë ti·ªÅn c·ªë ƒë·ªãnh</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="value">Gi√° tr·ªã gi·∫£m *</label>
                        <input type="number" id="value" name="value" required min="0" step="0.01" placeholder="V√≠ d·ª•: 20 ho·∫∑c 50000">
                    </div>
                    <div class="form-group">
                        <label for="max_discount">Gi·∫£m t·ªëi ƒëa</label>
                        <input type="number" id="max_discount" name="max_discount" min="0" step="0.01" placeholder="Gi·ªõi h·∫°n gi·∫£m gi√°">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="scope">Ph·∫°m vi √°p d·ª•ng *</label>
                        <select id="scope" name="scope" required>
                            <option value="order">To√†n b·ªô ƒë∆°n h√†ng</option>
                            <option value="product">S·∫£n ph·∫©m c·ª• th·ªÉ</option>
                            <option value="category">Danh m·ª•c s·∫£n ph·∫©m</option>
                            <option value="shipping">Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="min_order_value">Gi√° tr·ªã ƒë∆°n h√†ng t·ªëi thi·ªÉu</label>
                        <input type="number" id="min_order_value" name="min_order_value" min="0" step="1000" placeholder="VND">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="usage_limit">Gi·ªõi h·∫°n s·ª≠ d·ª•ng</label>
                        <input type="number" id="usage_limit" name="usage_limit" min="0" placeholder="S·ªë l·∫ßn s·ª≠ d·ª•ng t·ªëi ƒëa">
                    </div>
                    <div class="form-group">
                        <label for="start_at">Ng√†y b·∫Øt ƒë·∫ßu</label>
                        <input type="datetime-local" id="start_at" name="start_at">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="end_at">Ng√†y k·∫øt th√∫c</label>
                        <input type="datetime-local" id="end_at" name="end_at">
                    </div>
                    <div class="form-group">
                        <label for="is_active">Tr·∫°ng th√°i</label>
                        <select id="is_active" name="is_active">
                            <option value="1">ƒêang ho·∫°t ƒë·ªông</option>
                            <option value="0">Kh√¥ng ho·∫°t ƒë·ªông</option>
                        </select>
                    </div>
                </div>

                <div class="form-row full">
                    <div class="form-group">
                        <label for="description">M√¥ t·∫£</label>
                        <textarea id="description" name="description" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ m√£ gi·∫£m gi√°..." style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 5px; resize: vertical;"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="only_once_per_user" name="only_once_per_user" value="1">
                            Ch·ªâ s·ª≠ d·ª•ng m·ªôt l·∫ßn m·ªói ng∆∞·ªùi d√πng
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="first_time_only" name="first_time_only" value="1">
                            Ch·ªâ cho ƒë∆°n h√†ng ƒë·∫ßu ti√™n
                        </label>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="free_shipping" name="free_shipping" value="1">
                            Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="shipping_discount">Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn (VND)</label>
                        <input type="number" id="shipping_discount" name="shipping_discount" min="0" step="1000" placeholder="S·ªë ti·ªÅn gi·∫£m">
                    </div>
                </div>

                <div class="form-row">
                    <button type="submit" class="btn btn-success" style="width: 100%;">üíæ L∆∞u m√£ gi·∫£m gi√°</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let editingCouponId = null;

        // Kh·ªüi t·∫°o trang
        document.addEventListener('DOMContentLoaded', function() {
            loadCoupons();
            setupEventListeners();
        });

        function setupEventListeners() {
            // T√¨m ki·∫øm khi nh·∫≠p
            document.getElementById('search').addEventListener('input', debounce(loadCoupons, 500));
            
            // Filter khi thay ƒë·ªïi
            document.getElementById('status-filter').addEventListener('change', loadCoupons);
            document.getElementById('type-filter').addEventListener('change', loadCoupons);
            document.getElementById('scope-filter').addEventListener('change', loadCoupons);

            // Form submit
            document.getElementById('couponForm').addEventListener('submit', handleFormSubmit);

            // Thay ƒë·ªïi lo·∫°i gi·∫£m gi√°
            document.getElementById('type').addEventListener('change', function() {
                const valueInput = document.getElementById('value');
                const maxDiscountInput = document.getElementById('max_discount');
                
                if (this.value === 'percent') {
                    valueInput.placeholder = 'V√≠ d·ª•: 20 (20%)';
                    valueInput.max = '100';
                    maxDiscountInput.placeholder = 'Gi·ªõi h·∫°n gi·∫£m gi√° (VND)';
                } else {
                    valueInput.placeholder = 'V√≠ d·ª•: 50000 (VND)';
                    valueInput.removeAttribute('max');
                    maxDiscountInput.placeholder = 'Gi·ªõi h·∫°n gi·∫£m gi√° (VND)';
                }
            });

            // Thay ƒë·ªïi ph·∫°m vi
            document.getElementById('scope').addEventListener('change', function() {
                const shippingFields = document.getElementById('shipping_discount').parentElement.parentElement;
                if (this.value === 'shipping') {
                    shippingFields.style.display = 'grid';
                } else {
                    shippingFields.style.display = 'none';
                }
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function loadCoupons(page = 1) {
            currentPage = page;
            const container = document.getElementById('coupons-container');
            container.innerHTML = '<div class="loading">ƒêang t·∫£i danh s√°ch m√£ gi·∫£m gi√°...</div>';

            const search = document.getElementById('search').value;
            const status = document.getElementById('status-filter').value;
            const type = document.getElementById('type-filter').value;
            const scope = document.getElementById('scope-filter').value;

            try {
                const response = await fetch(`/api/v1/admin/coupons?page=${page}&search=${search}&is_active=${status}&type=${type}&scope=${scope}`);
                const data = await response.json();

                if (response.ok) {
                    displayCoupons(data.coupons);
                    displayPagination(data.pagination);
                } else {
                    container.innerHTML = `<div class="alert alert-error">L·ªói: ${data.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch m√£ gi·∫£m gi√°'}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">L·ªói k·∫øt n·ªëi: ${error.message}</div>`;
            }
        }

        function displayCoupons(coupons) {
            const container = document.getElementById('coupons-container');
            
            if (coupons.length === 0) {
                container.innerHTML = '<div class="loading">Kh√¥ng c√≥ m√£ gi·∫£m gi√° n√†o</div>';
                return;
            }

            const couponsHTML = coupons.map(coupon => `
                <div class="coupon-card">
                    <div class="coupon-header">
                        <div class="coupon-code">${coupon.code}</div>
                        <span class="coupon-status ${coupon.is_active ? 'status-active' : 'status-inactive'}">
                            ${coupon.is_active ? 'ƒêang ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}
                        </span>
                    </div>
                    
                    <div class="coupon-description">
                        ${coupon.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}
                    </div>
                    
                    <div class="coupon-details">
                        <div class="detail-item">
                            <div class="detail-label">Lo·∫°i:</div>
                            <div class="detail-value">${coupon.type === 'percent' ? 'Ph·∫ßn trƒÉm' : 'C·ªë ƒë·ªãnh'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Gi√° tr·ªã:</div>
                            <div class="detail-value">${coupon.type === 'percent' ? coupon.value + '%' : formatCurrency(coupon.value)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ph·∫°m vi:</div>
                            <div class="detail-value">${getScopeText(coupon.scope)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">S·ª≠ d·ª•ng:</div>
                            <div class="detail-value">${coupon.used_count}/${coupon.usage_limit || '‚àû'}</div>
                        </div>
                    </div>
                    
                    <div class="coupon-actions">
                        <button class="btn btn-warning" onclick="editCoupon(${coupon.id})">‚úèÔ∏è S·ª≠a</button>
                        <button class="btn btn-secondary" onclick="toggleCouponStatus(${coupon.id})">
                            ${coupon.is_active ? '‚è∏Ô∏è T·∫°m d·ª´ng' : '‚ñ∂Ô∏è K√≠ch ho·∫°t'}
                        </button>
                        <button class="btn btn-danger" onclick="deleteCoupon(${coupon.id})">üóëÔ∏è X√≥a</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = couponsHTML;
        }

        function displayPagination(pagination) {
            const paginationContainer = document.getElementById('pagination');
            totalPages = pagination.last_page;
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // N√∫t Previous
            paginationHTML += `<button onclick="loadCoupons(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>‚Üê Tr∆∞·ªõc</button>`;
            
            // C√°c trang
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<button onclick="loadCoupons(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += `<button disabled>...</button>`;
                }
            }
            
            // N√∫t Next
            paginationHTML += `<button onclick="loadCoupons(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>Sau ‚Üí</button>`;
            
            paginationContainer.innerHTML = paginationHTML;
        }

        function getScopeText(scope) {
            const scopeMap = {
                'order': 'To√†n b·ªô ƒë∆°n h√†ng',
                'product': 'S·∫£n ph·∫©m c·ª• th·ªÉ',
                'category': 'Danh m·ª•c s·∫£n ph·∫©m',
                'shipping': 'Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn'
            };
            return scopeMap[scope] || scope;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function openCreateModal() {
            editingCouponId = null;
            document.getElementById('modalTitle').textContent = 'T·∫°o m√£ gi·∫£m gi√° m·ªõi';
            document.getElementById('couponForm').reset();
            document.getElementById('couponModal').style.display = 'block';
            document.getElementById('alert-container').innerHTML = '';
        }

        function editCoupon(id) {
            editingCouponId = id;
            document.getElementById('modalTitle').textContent = 'S·ª≠a m√£ gi·∫£m gi√°';
            document.getElementById('couponModal').style.display = 'block';
            document.getElementById('alert-container').innerHTML = '';
            
            // T·∫£i th√¥ng tin m√£ gi·∫£m gi√°
            loadCouponDetails(id);
        }

        async function loadCouponDetails(id) {
            try {
                const response = await fetch(`/api/v1/admin/coupons/${id}`);
                const data = await response.json();
                
                if (response.ok) {
                    fillCouponForm(data.coupon);
                } else {
                    showAlert('L·ªói khi t·∫£i th√¥ng tin m√£ gi·∫£m gi√°', 'error');
                }
            } catch (error) {
                showAlert('L·ªói k·∫øt n·ªëi', 'error');
            }
        }

        function fillCouponForm(coupon) {
            document.getElementById('code').value = coupon.code;
            document.getElementById('description').value = coupon.description || '';
            document.getElementById('type').value = coupon.type;
            document.getElementById('value').value = coupon.value;
            document.getElementById('max_discount').value = coupon.max_discount || '';
            document.getElementById('scope').value = coupon.scope;
            document.getElementById('min_order_value').value = coupon.min_order_value || '';
            document.getElementById('usage_limit').value = coupon.usage_limit || '';
            document.getElementById('start_at').value = coupon.start_at ? coupon.start_at.slice(0, 16) : '';
            document.getElementById('end_at').value = coupon.end_at ? coupon.end_at.slice(0, 16) : '';
            document.getElementById('is_active').value = coupon.is_active ? '1' : '0';
            document.getElementById('only_once_per_user').checked = coupon.only_once_per_user;
            document.getElementById('first_time_only').checked = coupon.first_time_only;
            document.getElementById('free_shipping').checked = coupon.free_shipping;
            document.getElementById('shipping_discount').value = coupon.shipping_discount || '';
            
            // Trigger change events
            document.getElementById('type').dispatchEvent(new Event('change'));
            document.getElementById('scope').dispatchEvent(new Event('change'));
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            // Convert checkboxes
            data.only_once_per_user = data.only_once_per_user === '1';
            data.first_time_only = data.first_time_only === '1';
            data.free_shipping = data.free_shipping === '1';
            data.is_active = data.is_active === '1';
            
            // Convert empty strings to null
            Object.keys(data).forEach(key => {
                if (data[key] === '') data[key] = null;
            });

            try {
                const url = editingCouponId ? `/api/v1/admin/coupons/${editingCouponId}` : '/api/v1/admin/coupons';
                const method = editingCouponId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert(result.message, 'success');
                    closeModal();
                    loadCoupons(currentPage);
                } else {
                    showAlert(result.message || 'C√≥ l·ªói x·∫£y ra', 'error');
                }
            } catch (error) {
                showAlert('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }

        async function toggleCouponStatus(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën thay ƒë·ªïi tr·∫°ng th√°i m√£ gi·∫£m gi√° n√†y?')) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/admin/coupons/${id}/toggle-status`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(result.message, 'success');
                    loadCoupons(currentPage);
                } else {
                    showAlert(result.message || 'C√≥ l·ªói x·∫£y ra', 'error');
                }
            } catch (error) {
                showAlert('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }

        async function deleteCoupon(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√£ gi·∫£m gi√° n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/admin/coupons/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(result.message, 'success');
                    loadCoupons(currentPage);
                } else {
                    showAlert(result.message || 'C√≥ l·ªói x·∫£y ra', 'error');
                }
            } catch (error) {
                showAlert('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }

        function closeModal() {
            document.getElementById('couponModal').style.display = 'none';
            document.getElementById('couponForm').reset();
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            alertContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        function exportCoupons() {
            // Implement export functionality
            alert('T√≠nh nƒÉng xu·∫•t d·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn sau');
        }

        // ƒê√≥ng modal khi click b√™n ngo√†i
        window.onclick = function(event) {
            const modal = document.getElementById('couponModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
